<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Solução - Fase II</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .accordion-item { border: 1px solid #e5e7eb; margin-bottom: 0.5rem; }
        .accordion-header { padding: 1rem; cursor: pointer; font-weight: 600; background: #fff; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: #f9fafb; }
        .accordion-content-inner { padding: 1rem; }
        .item-status { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; }
        .bg-green { background: #bbf7d0; color: #166534; }
        .bg-gray { background: #e5e7eb; color: #374151; }
    </style>
</head>
<body class="p-6">

    <h1 class="text-2xl font-bold mb-6">Formulário de Solução - Fase II</h1>

    <!-- FORM PRINCIPAL COM FORMspree -->
    <form id="solutionForm" action="https://formspree.io/f/mrbykeyg" method="POST" class="space-y-6">
        
        <!-- Campo oculto para sector -->
        <input type="hidden" name="sector" id="sectorHidden">

        <!-- Seletor de Sector -->
        <label for="sector-select" class="block text-sm font-medium">Selecione o Sector:</label>
        <select id="sector-select" class="border rounded-md px-3 py-2" onchange="changeSector()" required>
            <option value="" disabled selected>--- Escolha um sector ---</option>
        </select>

        <!-- Nota Introdutória -->
        <div>
            <label for="introNote" class="block font-semibold mb-1">Nota Introdutória:</label>
            <textarea id="introNote" name="introNote" rows="4" class="w-full border rounded-md p-2"></textarea>
        </div>

        <!-- Vulnerabilidades -->
        <h2 class="text-lg font-bold">Vulnerabilidades</h2>
        <div id="vulnerabilitiesSection"></div>

        <!-- Botões -->
        <div class="flex gap-4">
            <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md">Enviar</button>
            <button type="button" onclick="saveData()" class="bg-indigo-600 text-white px-4 py-2 rounded-md">Salvar Local</button>
        </div>
    </form>

    <!-- Mensagem de confirmação -->
    <div id="save-confirmation" class="hidden mt-4 p-3 rounded-md bg-green-500 text-white"></div>

<script>
    // --- DADOS EXEMPLO ---
    const ALL_SECTOR_DATA = {
        "ADMINISTRATIVO": {
            gestor: "Mário Almeida",
            vulnerabilities: [
                "Gestão de arquivo geral de correspondência",
                "Gestão e controlo do ficheiro geral de pessoal",
                "Atribuir autonomia administrativa e financeira"
            ]
        },
        "ARMAZÉM 1": {
            gestor: "Arif Daligy",
            vulnerabilities: [
                "Ausência do chefe do sector",
                "Entrega de produtos sem controlo adequado",
                "Falta de feedback da área de produção"
            ]
        }
    };

    let currentSector = null;

    // Preencher selector de sectores
    function fillSectorSelect() {
        const select = document.getElementById("sector-select");
        Object.keys(ALL_SECTOR_DATA).forEach(sector => {
            const option = document.createElement("option");
            option.value = sector;
            option.textContent = sector;
            select.appendChild(option);
        });
    }

    // Alterar sector
    function changeSector() {
        const selected = document.getElementById("sector-select").value;
        currentSector = ALL_SECTOR_DATA[selected];
        document.getElementById("sectorHidden").value = selected;

        const section = document.getElementById("vulnerabilitiesSection");
        section.innerHTML = "";

        if (currentSector && currentSector.vulnerabilities) {
            currentSector.vulnerabilities.forEach((vul, i) => {
                const key = `vul-${i+1}`;
                section.innerHTML += `
                    <div class="accordion-item" data-key="${key}">
                        <div class="accordion-header flex justify-between">
                            <span>${vul}</span>
                            <span class="item-status bg-gray">Não Salvo</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-content-inner">
                                <label for="solution-${key}" class="block text-sm font-medium">Proposta de Solução:</label>
                                <textarea id="solution-${key}" name="solution-${key}" 
                                    data-solution-key="${key}" rows="3" class="w-full border rounded-md p-2"
                                    oninput="updateStatus('${key}')" onchange="saveData()"></textarea>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
    }

    // Atualizar status
    function updateStatus(key) {
        const item = document.querySelector(`.accordion-item[data-key="${key}"]`);
        if (!item) return;
        const status = item.querySelector(".item-status");
        const textarea = document.getElementById(`solution-${key}`);
        if (textarea.value.trim().length > 0) {
            status.textContent = "Preenchido";
            status.className = "item-status bg-green";
        } else {
            status.textContent = "Não Salvo";
            status.className = "item-status bg-gray";
        }
    }

    // Salvar localmente (localStorage)
    function saveData() {
        if (!currentSector) return;
        const sectorKey = document.getElementById("sector-select").value;
        const data = {
            introNote: document.getElementById("introNote").value,
            solutions: {}
        };
        document.querySelectorAll("textarea[data-solution-key]").forEach(t => {
            data.solutions[t.id] = t.value;
        });
        localStorage.setItem(`data_${sectorKey}`, JSON.stringify(data));
        showConfirmation("Progresso salvo localmente!");
    }

    // Mostrar confirmação
    function showConfirmation(msg) {
        const div = document.getElementById("save-confirmation");
        div.textContent = msg;
        div.classList.remove("hidden");
        setTimeout(() => div.classList.add("hidden"), 3000);
    }

    // Iniciar
    window.onload = fillSectorSelect;
</script>
</body>
</html>
